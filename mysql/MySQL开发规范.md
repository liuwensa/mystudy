# MySQL开发规范

## 命名规范
1. 库名、表名、字段名必须使用小写字母，并采用下划线分割
2. 库名、表名、字段名禁止超过32个字符。须见名知意
3. 库名、表名、字段名禁止使用`MySQL`保留字
4. 表名以`tbl`开头，下划线分割，如`tbl_articles`
5. 临时库、表名必须以`tmp`为前缀，并以日期为后缀
6. 备份库、表必须以`bak`为前缀，并以日期为后缀

## 基础规范
1. 使用`INNODB`存储引擎
2. 表字符集使用`UTF8`
3. 所有表都需要添加注释
4. 单表数据量建议控制在5000W以内
5. 不在数据库中存储图片、文件等大数据
6. 禁止在线上做数据库压力测试

## 库、表、字段开发设计规范
1. 尽可能不使用`TEXT`、`BLOB`类型
2. 用`DECIMAL`代替`FLOAT`和`DOUBLE`存储精确浮点数
3. 所有字段均定义为`NOT NULL`，避免使用`NULL`字段
4. 禁止在数据库中存储明文密码，把密码加密后存储
5. 存储`ip`最好用`INT`存储而非`VARCHAR(15)`
6. 定义varchar根据实际情况限制长度，如`VARCHAR(15)`
7. 时间一般用时间戳存储，采用长整形`BIGINT(20)`
8. 字段数量建议不超过20-50个
9. 字段类型在满足需求条件下越小越好，尽量使用UNSIGNED存储非负整数

## 索引规范
1. 索引的数量要控制
 - 单张表中索引数量不超过5个
 - 单个索引中的字段数不超过5个
 - 对字符串使用前缀索引，前缀索引长度不超过8个字符
 - 建议优先考虑前缀索引，必要时可添加伪列并建立索引
2. 主键准则
 - 表必须有主键，尽量使用短、自增的列
 - 不使用更新频繁的列作为主键
 - 尽量不选择字符串列作为主键
 - 不使用`UUID`、`MD5`、`HASH`这些作为主键(数值太离散了)
 - 默认使非空的唯一键作为主键
 - 建议选择自增或发号器
3. 重要的`SQL`必须被索引，比如：
 - `UPDATE`、`DELETE`语句的`WHERE`条件列
 - `ORDER BY`、`GROUP BY`、`DISTINCT`的字段
4. 多表`JOIN`的字段注意以下：
 - 区分度最大的字段放在前面
 - 核心`SQL`优先考虑覆盖索引
 - 避免冗余和重复索引
 - 索引要综合评估数据密度和分布以及考虑查询和更新比例
5. 索引禁忌
 - 不在低基数列上建立索引，例如性别、状态等
 - 不在索引列进行数学运算和函数运算
6. 索引命名，非唯一索引必须以`idx_字段1_字段2`命名，唯一所以必须以`uniq_字段1_字段2`命名，索引名称必须全部小写
7. 新建的唯一索引必须不能和主键重复
8. 索引字段的默认值不能为`NULL`
9. 反复查看与表相关的`SQL`，符合最左前缀的特点建立索引。多条字段重复的语句，要修改语句条件字段的顺序，为其建立一条联合索引，减少索引数量
10. 能使用唯一索引就要使用唯一索引，提高查询效率
11. 研发要经常使用`EXPLAIN`，如果发现索引选择性差，必须让他们学会使用`HINT`

## SQL规范
1. `SQL`语句尽可能简单
  大的`SQL`想办法拆成小的`SQL`语句(充分利用`QUERY CACHE`和充分利用多核`CPU`)
2. 事务要简单，整个事务的时间长度不要太长
3. 避免使用触发器、函数、存储过程
4. 避免在数据库中进行数学运算(MySQL不擅长数学运算和逻辑判断)
5. 不要用`SELECT *`，查询哪几个字段就`SELECT`这几个字段
6. `SQL`中使用到`OR`的改写为用`IN()`，`IN`里面数字的个数建议控制在1000以内，要学会使用`EXIST`代替`IN`，`EXIST`在一些场景查询会比`IN`快
7. `LIMIT`分页注意效率。`LIMIT`越大，效率越低。程序里合理使用分页来提高效率`LIMIT`，`OFFSET`较大要配合子查询使用
8. 使用`UNION ALL`替代`UNION`
9. 避免使用大表的`JOIN`，考虑用小表去驱动大表`JOIN`，最多允许三表`JOIN`，最好控制成两个表，控制`JOIN`后面`WHERE`选择的行数
10. 使用`GROUP BY`分组、自动排序
11. 对数据的更新要打散后批量更新，不要一次更新太多数据
12. 减少与数据库的交互次数
13. `SQL`语句中`SQL`关键字全部是大写
15. 禁止在数据库中跑大查询
15. 使用预编译语句，只传参数，比传递SQL语句更高效；一次解析，多次使用；降低SQL注入概率
16. 禁止单条`SQL`语句同时更新多个表

## Schema Review

1. 表字符集选择UTF8 ，如需存储emoj表情，就改成UTF8mb4
2.  Schema设计原则
 - 核心表字段数量尽可能地少，有大字段要考虑拆分
 - 适当考虑一些反范式的表设计，增加冗余字段，减少JOIN
 - 资金字段考虑统一*100处理成整型，避免使用decimal浮点类型存储
 - 日志类型的表可以考虑按创建时间水平切割，定期归档历史数据
3. Schema设计目标
 - 快速实现功能为主，保证节省资源
 - 平衡业务技术各个方面，做好取舍
 - 不要在DB里进行大计算，减少复杂操作